<!DOCTYPE html>
<html>

<head>
    <title>WebSocket Test Client</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }

        .connected {
            color: green;
        }

        .disconnected {
            color: red;
        }

        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            background: #f5f5f5;
            font-family: monospace;
            font-size: 12px;
        }

        .message {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-left: 3px solid #4CAF50;
        }

        input {
            padding: 8px;
            width: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>WebSocket Test Client</h1>

        <div>
            <strong>Status:</strong> <span id="status" class="disconnected">Disconnected</span>
        </div>

        <div style="margin: 20px 0;">
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        </div>

        <div style="margin: 20px 0;">
            <h3>Subscribe to Topic:</h3>
            <select id="userType">
                <option value="restaurant">Restaurant</option>
                <option value="driver">Driver</option>
                <option value="customer">Customer</option>
            </select>
            <input type="number" id="userId" placeholder="User ID" value="1">
            <button onclick="subscribe()">Subscribe</button>
        </div>

        <h3>Messages:</h3>
        <div id="messages"></div>
        <button onclick="clearMessages()">Clear Messages</button>
    </div>

    <script>
        let stompClient = null;
        let currentSubscription = null;

        function connect() {
            const socket = new SockJS('https://eatzy-be.hoanduong.net/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').className = 'connected';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                addMessage('System', 'Connected to WebSocket server');
            }, function (error) {
                console.error('Connection error:', error);
                addMessage('Error', 'Connection failed: ' + error);
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').className = 'disconnected';
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'disconnected';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            addMessage('System', 'Disconnected from WebSocket server');
        }

        function subscribe() {
            if (stompClient === null || !stompClient.connected) {
                alert('Please connect first!');
                return;
            }

            const userType = document.getElementById('userType').value;
            const userId = document.getElementById('userId').value;
            const topic = `/topic/${userType}/${userId}/orders`;

            // Unsubscribe from previous topic
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }

            currentSubscription = stompClient.subscribe(topic, function (message) {
                const notification = JSON.parse(message.body);
                console.log('Received notification:', notification);
                addMessage('Notification', JSON.stringify(notification, null, 2));

                // Play sound notification
                playNotificationSound();
            });

            addMessage('System', 'Subscribed to: ' + topic);
        }

        function addMessage(type, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            const time = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `<strong>[${time}] ${type}:</strong><br>${content}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function playNotificationSound() {
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Auto-connect on page load
        window.onload = function () {
            console.log('Page loaded, ready to connect');
        };
    </script>
</body>

</html>